<!DOCTYPE html>
<html>
<head>
    
    <title>Nornenjs Example</title>

    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, width=device-width" />
    
    <script src="http://${ipAddress}:5000/socket.io/socket.io.js"></script>
    
    <script>

        var socket = io.connect('http://${ipAddress}:5000', { reconnection : false } );
        var fps = 0;

        /**
         * send connect message to server
         */
        socket.emit('connectMessage');

        /**
         * emit connect - response message
         */
        socket.on('connectMessage', function(message){
            if(!message.success){
                alert(message.error);
                return;
            }
            
            socket.emit('init');
        });

        /**
         * Socket stream data
         */
        socket.on('stream', function(imageBlob){
            
            var blob = new Blob( [ imageBlob ], { type: 'image/jpeg' } );
            var url = (window.URL || window.webkitURL).createObjectURL(blob);
            var canvas = document.getElementById('view_canvas');
            var ctx = canvas.getContext('2d');

            var img = new Image(512, 512);
            img.onload = function(){
                ctx.drawImage(img, 0, 0, 512, 512, 0, 0, canvas.clientWidth, canvas.clientWidth);
                fps++;
            };
            img.src = url;
        });

        /**
         * Other client disconnect
         */
        socket.on('otherClientDisconnect', function(){
            socket.emit('connectMessage');
        });
        
        setInterval(function(){ console.log(fps); fps = 0; }, 1000);

    </script>
    
</head>
<body>

<canvas id="view_canvas" width="512" height="512">

</canvas>

<script>
    
    // ~ Touch

    var canvas = document.getElementById('view_canvas');

    var touch = {
        isOn : false,
        beforeX : 0,
        beforeY : 0
    };

    var mouse = {
        isOn : false,
        beforeX : 0,
        beforeY : 0,
        count : 0
    };
    
    var option = {
        rotationX : 0,
        rotationY : 0
    };

    canvas.addEventListener('touchstart', function(event){
        event.preventDefault();
        var touches = event.changedTouches;

        if(touches.length == 1){
            touch.isOn = true;
            touch.beforeX = touches[0].pageX;
            touch.beforeY = touches[0].pageY;
        }
    });

    canvas.addEventListener('touchmove', function(event){
        event.preventDefault();
        var touches = event.changedTouches;

        if(touch.isOn){
            option.rotationX += (touches[0].pageX - touch.beforeX)/10.0;
            option.rotationY += (touches[0].pageY - touch.beforeY)/10.0;

            touch.beforeX = touches[0].pageX;
            touch.beforeY = touches[0].pageY;

            socket.emit('event', option);
        }
    });

    canvas.addEventListener('touchend', function(event){
        event.preventDefault();
        touch.isOn = false;
    });

    canvas.addEventListener('touchcancel', fuKnction handleCancel(event) {
        event.preventDefault();
        touch.isOn = false;
    });

    canvas.addEventListener('touchleave', function(event){
        event.preventDefault();
        touch.isOn = false;
    });


    canvas.addEventListener('mousedown', function(event){
        event.preventDefault();

        mouse.isOn = true;
        mouse.beforeX = event.pageX;
        mouse.beforeY = event.pageY;
        mouse.count = 0;
    });

    canvas.addEventListener('mousemove', function(event){
        event.preventDefault();
        mouse.count++;
        if(mouse.isOn && mouse.count%3 == 0){
            option.rotationX += (event.pageX - mouse.beforeX)/3.0;
            option.rotationY += (event.pageY - mouse.beforeY)/3.0;

            mouse.beforeX = event.pageX;
            mouse.beforeY = event.pageY;

            socket.emit('event', option);
        }
    });

    canvas.addEventListener('mouseup', function(event){
        event.preventDefault();
        mouse.isOn = false;
    });


</script>

</body>
</html>